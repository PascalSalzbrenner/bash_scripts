#!/bin/bash

# bash script to run VASP calculations with user-provided INCAR, POSCAR, POTCAR, and KPOINTS at different temperatures
# temperature-dependent lattice parameters must be given in minimum_energy.txt file, generated by my Caesar-based temperatured-dependent geometry optimisation routines

min_T=$1
max_T=$2
dT=$3

ncores=$((`nproc --all`/2))

for i in `seq $min_T $dT $max_T`; do
	
	T_string=T_${i}K

	# read lattice parameter at that temperature from minimum_energy.txt file
	lattice_parameter=`awk -v temperature="$T_string" '$0 ~ temperature {print $2}' minimum_energy.txt`
		
	mkdir $T_string
	cp INCAR $T_string
	cp KPOINTS $T_string
	cp POTCAR $T_string

	# copy any potential additional input files such as WAVECAR or CHGCAR, which must also be supplied
	if [ -f WAVECAR ]; then
		cp WAVECAR $T_string 
	fi

	# test for CHGCAR file at this temperature
	if [ -f CHGCAR ]; then
		cp CHGCAR $T_string 
	elif [ -f CHGCAR_${i} ]; then
		mv CHGCAR_${i} $T_string/CHGCAR
	fi

	sed "s/lattice_parameter/$lattice_parameter/g" POSCAR > $T_string/POSCAR

	cd $T_string

	echo "Now running VASP calculation at $i K"

	if [ ! -f "OUTCAR" ]; then
		if [ `awk '{FS = "="} /LSORBIT/ {print $2}' INCAR` == ".TRUE." ]; then
			mpirun -np $ncores vasp_ncl
		else
			mpirun -np $ncores vasp_std 
		fi

		run_successful=`grep "General" OUTCAR` # when VASP completes a job successfully, it prints some "General timing and accounting informations for this job" at the very end of OUTCAR. Thus, if the job terminates prematurely, run_successful will be empty

		while [ `python3 -c "print(int(not '$run_successful'))"` -eq 1 ]; do
                        # not '$run_successful' is true, that is, the run was not successful ($run_successful is empty)
                        delete_vasp_output

                        if [ `awk '{FS = "="} /LSORBIT/ {print $2}' INCAR` == ".TRUE." ]; then
                                mpirun -np $ncores vasp_ncl
                        else
                                mpirun -np $ncores vasp_std
                        fi

                        run_successful=`grep "General" OUTCAR`
                done
                # when this loop is left, we had a successful run
	fi
	cd ..
done
